# Rootara åŸºå› æ•°æ®åˆ†æå¹³å° - éƒ¨ç½²é€‰æ‹©è¯´æ˜
#
# ğŸ¯ è¯·é€‰æ‹©é€‚åˆçš„éƒ¨ç½²ç‰ˆæœ¬ï¼š
#
# ğŸ“ docker-compose.standard.yml - æ ‡å‡†ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
#   - å†…å­˜å ç”¨ï¼šçº¦70-80MB
#   - æ€§èƒ½ï¼šå«Redisç¼“å­˜ï¼Œå“åº”é€Ÿåº¦å¿«ï¼ˆæå‡70-90%ï¼‰
#   - é€‚ç”¨ï¼šç”Ÿäº§ç¯å¢ƒï¼Œå†…å­˜å……è¶³çš„æœåŠ¡å™¨ï¼ˆ>1GBï¼‰
#   - éƒ¨ç½²ï¼šdocker-compose -f docker-compose.standard.yml up -d
#
# ğŸ“ docker-compose.lite.yml - è½»é‡ç‰ˆæœ¬
#   - å†…å­˜å ç”¨ï¼šçº¦30-40MBï¼ˆèŠ‚çœ50MBï¼‰
#   - æ€§èƒ½ï¼šå†…å­˜ç¼“å­˜ï¼Œå“åº”ç¨æ…¢ä½†å¤Ÿç”¨
#   - é€‚ç”¨ï¼šå†…å­˜æœ‰é™çš„æœåŠ¡å™¨ï¼ˆ<1GBï¼‰ï¼Œä¸ªäººå­¦ä¹ ä½¿ç”¨
#   - éƒ¨ç½²ï¼šdocker-compose -f docker-compose.lite.yml up -d
#
# ğŸ’¡ å¦‚ä½•é€‰æ‹©ï¼š
# - å†…å­˜ > 1GBï¼šé€‰æ‹© standard.yml
# - å†…å­˜ < 1GBï¼šé€‰æ‹© lite.yml
# - ç”Ÿäº§ç¯å¢ƒï¼šæ¨è standard.yml
# - ä¸ªäººå­¦ä¹ ï¼šlite.yml å³å¯
#
# ğŸ“– ä¸¤ä¸ªç‰ˆæœ¬çš„é…ç½®å®Œå…¨ç›¸åŒï¼Œåªæ˜¯Redisç¼“å­˜çš„å·®å¼‚

version: '3.8'

services:
  # å‰ç«¯æœåŠ¡ - ç”¨æˆ·è®¿é—®ç•Œé¢
  frontend:
    image: ghcr.io/pzweuj/rootara:latest
    container_name: rootara-frontend
    ports:
      - "3000:3000"                                              # ğŸ”§ å¯ä¿®æ”¹ç«¯å£ï¼šå¦‚éœ€æ”¹ä¸ºå…¶ä»–ç«¯å£ï¼Œä¿®æ”¹å‰é¢çš„æ•°å­—
    environment:
      # ğŸ”§ ç®¡ç†å‘˜è´¦å·é…ç½® - å»ºè®®ä¿®æ”¹
      - ADMIN_EMAIL=admin@rootara.app                            # ğŸ”§ ç®¡ç†å‘˜é‚®ç®±
      - ADMIN_PASSWORD=rootara123                                # ğŸ”§ ç®¡ç†å‘˜å¯†ç 

      # ğŸ”§ å®‰å…¨é…ç½® - å»ºè®®ä¿®æ”¹
      - JWT_SECRET=rootara_jwt_secret                            # ğŸ”§ JWTå¯†é’¥ï¼Œå»ºè®®ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²
      - ROOTARA_BACKEND_API_KEY=rootara_api_key_default_001      # ğŸ”§ APIå¯†é’¥ï¼Œéœ€ä¸åç«¯ä¿æŒä¸€è‡´

      # é»˜è®¤é…ç½®ï¼ˆé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰
      - TZ=Asia/Shanghai
      - ROOTARA_BACKEND_URL=http://backend:8000
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  # åç«¯æœåŠ¡ - APIæ¥å£
  backend:
    image: ghcr.io/pzweuj/rootara-backend:latest
    container_name: rootara-backend
    command: /bin/bash /app/init.sh
    volumes:
      - ./data:/data                                             # æ•°æ®å­˜å‚¨ç›®å½•
      - ./logs:/app/logs                                         # æ—¥å¿—å­˜å‚¨ç›®å½•
    environment:
      # ğŸ”§ APIå¯†é’¥é…ç½® - éœ€ä¸å‰ç«¯ä¿æŒä¸€è‡´
      - ROOTARA_API_KEY=rootara_api_key_default_001              # ğŸ”§ APIå¯†é’¥ï¼Œéœ€ä¸å‰ç«¯ä¿æŒä¸€è‡´

      # é»˜è®¤é…ç½®ï¼ˆé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰
      - TZ=Asia/Shanghai
      - LOG_LEVEL=INFO
      - LOG_CONSOLE=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_TTL=3600
      - DB_PATH=/data/rootara.db
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Redisç¼“å­˜æœåŠ¡ - æå‡æ€§èƒ½ï¼ˆé»˜è®¤é…ç½®å³å¯ï¼‰
  redis:
    image: redis:7.4-alpine
    container_name: rootara-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

volumes:
  redis_data:
    driver: local

networks:
  default:
    name: rootara

# ğŸ”§ å¸¸ç”¨å‘½ä»¤ï¼š
# æ ‡å‡†æ¨¡å¼å¯åŠ¨ï¼šdocker-compose up -d
# è½»é‡æ¨¡å¼å¯åŠ¨ï¼šdocker-compose -f docker-compose.yml -f docker-compose.lite.yml up -d
# åœæ­¢ï¼šdocker-compose down
# æŸ¥çœ‹æ—¥å¿—ï¼šdocker-compose logs -f
# é‡å¯ï¼šdocker-compose restart
#
# ğŸ’¡ æ¨¡å¼é€‰æ‹©å»ºè®®ï¼š
# - å†…å­˜ > 1GBï¼šé€‰æ‹©æ ‡å‡†æ¨¡å¼ï¼ˆæ›´å¿«çš„å“åº”é€Ÿåº¦ï¼‰
# - å†…å­˜ < 1GBï¼šé€‰æ‹©è½»é‡æ¨¡å¼ï¼ˆæ›´ä½çš„èµ„æºå ç”¨ï¼‰
# - ç”Ÿäº§ç¯å¢ƒï¼šæ¨èæ ‡å‡†æ¨¡å¼
# - ä¸ªäººå­¦ä¹ ï¼šè½»é‡æ¨¡å¼å³å¯
#
# ğŸ“– é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š
# - Rediså†…å­˜è°ƒæ•´ï¼šä¿®æ”¹ redis æœåŠ¡çš„ --maxmemory å‚æ•°
# - ç¼“å­˜æ—¶é—´è°ƒæ•´ï¼šä¿®æ”¹ backend æœåŠ¡çš„ CACHE_TTL ç¯å¢ƒå˜é‡
# - Rediså¯†ç ä¿æŠ¤ï¼šåœ¨ redis å‘½ä»¤ä¸­æ·»åŠ  --requirepass å‚æ•°
