# Rootara åŸºå› æ•°æ®åˆ†æå¹³å° - æ ‡å‡†ç‰ˆæœ¬ï¼ˆå«Redisç¼“å­˜ï¼‰
#
# ğŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆ2æ­¥å®Œæˆï¼‰ï¼š
# 1. ç¡®ä¿å·²å®‰è£… Docker å’Œ Docker Compose
# 2. è¿è¡Œï¼šdocker-compose -f docker-compose.standard.yml up -d
# 3. è®¿é—®ï¼šhttp://localhost:3000ï¼ˆç”¨æˆ·åï¼šadmin@rootara.app å¯†ç ï¼šrootara123ï¼‰
#
# ğŸ“Š æ ‡å‡†ç‰ˆæœ¬ç‰¹æ€§ï¼š
# - å†…å­˜å ç”¨ï¼šçº¦70-80MB
# - æ€§èƒ½ï¼šRedisç¼“å­˜ï¼Œå“åº”é€Ÿåº¦å¿«ï¼ˆæå‡70-90%ï¼‰
# - é€‚ç”¨ï¼šç”Ÿäº§ç¯å¢ƒï¼Œå†…å­˜å……è¶³çš„æœåŠ¡å™¨
#
# âš ï¸ éœ€è¦ä¿®æ”¹çš„é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
# - ç®¡ç†å‘˜é‚®ç®±å’Œå¯†ç ï¼ˆè§ä¸‹æ–¹ ADMIN_EMAIL å’Œ ADMIN_PASSWORDï¼‰
# - è®¿é—®ç«¯å£ï¼ˆé»˜è®¤3000ï¼Œè§ä¸‹æ–¹ ports é…ç½®ï¼‰
# - APIå¯†é’¥ï¼ˆè§ä¸‹æ–¹ ROOTARA_API_KEYï¼Œå‰åç«¯éœ€ä¿æŒä¸€è‡´ï¼‰

version: '3.8'

services:
  # å‰ç«¯æœåŠ¡ - ç”¨æˆ·è®¿é—®ç•Œé¢
  frontend:
    image: ghcr.io/pzweuj/rootara:latest
    container_name: rootara-frontend
    ports:
      - "3000:3000"                                              # ğŸ”§ å¯ä¿®æ”¹ç«¯å£ï¼šå¦‚éœ€æ”¹ä¸ºå…¶ä»–ç«¯å£ï¼Œä¿®æ”¹å‰é¢çš„æ•°å­—
    environment:
      # ğŸ”§ ç®¡ç†å‘˜è´¦å·é…ç½® - å»ºè®®ä¿®æ”¹
      - ADMIN_EMAIL=admin@rootara.app                            # ğŸ”§ ç®¡ç†å‘˜é‚®ç®±
      - ADMIN_PASSWORD=rootara123                                # ğŸ”§ ç®¡ç†å‘˜å¯†ç 

      # ğŸ”§ å®‰å…¨é…ç½® - å»ºè®®ä¿®æ”¹
      - JWT_SECRET=rootara_jwt_secret                            # ğŸ”§ JWTå¯†é’¥ï¼Œå»ºè®®ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²
      - ROOTARA_BACKEND_API_KEY=rootara_api_key_default_001      # ğŸ”§ APIå¯†é’¥ï¼Œéœ€ä¸åç«¯ä¿æŒä¸€è‡´

      # é»˜è®¤é…ç½®ï¼ˆé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰
      - TZ=Asia/Shanghai
      - ROOTARA_BACKEND_URL=http://backend:8000
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

  # åç«¯æœåŠ¡ - APIæ¥å£
  backend:
    image: ghcr.io/pzweuj/rootara-backend:latest
    container_name: rootara-backend
    command: /bin/bash /app/init.sh
    volumes:
      - ./data:/data                                             # æ•°æ®å­˜å‚¨ç›®å½•
      - ./logs:/app/logs                                         # æ—¥å¿—å­˜å‚¨ç›®å½•
    environment:
      # ğŸ”§ APIå¯†é’¥é…ç½® - éœ€ä¸å‰ç«¯ä¿æŒä¸€è‡´
      - ROOTARA_API_KEY=rootara_api_key_default_001              # ğŸ”§ APIå¯†é’¥ï¼Œéœ€ä¸å‰ç«¯ä¿æŒä¸€è‡´

      # é»˜è®¤é…ç½®ï¼ˆé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰
      - TZ=Asia/Shanghai
      - LOG_LEVEL=INFO
      - LOG_CONSOLE=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CACHE_TTL=3600
      - DB_PATH=/data/rootara.db
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Redisç¼“å­˜æœåŠ¡ - æå‡æ€§èƒ½ï¼ˆé»˜è®¤é…ç½®å³å¯ï¼‰
  redis:
    image: redis:7.4-alpine
    container_name: rootara-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  redis_data:
    driver: local

networks:
  default:
    name: rootara

# ğŸ”§ å¸¸ç”¨å‘½ä»¤ï¼š
# å¯åŠ¨ï¼šdocker-compose -f docker-compose.standard.yml up -d
# åœæ­¢ï¼šdocker-compose -f docker-compose.standard.yml down
# æŸ¥çœ‹æ—¥å¿—ï¼šdocker-compose -f docker-compose.standard.yml logs -f
# é‡å¯ï¼šdocker-compose -f docker-compose.standard.yml restart
#
# ğŸ“– é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š
# - Rediså†…å­˜è°ƒæ•´ï¼šä¿®æ”¹ redis æœåŠ¡çš„ --maxmemory å‚æ•°ï¼ˆå¦‚512mbã€1gbï¼‰
# - ç¼“å­˜æ—¶é—´è°ƒæ•´ï¼šä¿®æ”¹ backend æœåŠ¡çš„ CACHE_TTL ç¯å¢ƒå˜é‡
# - Rediså¯†ç ä¿æŠ¤ï¼šåœ¨ redis å‘½ä»¤ä¸­æ·»åŠ  --requirepass å‚æ•°
